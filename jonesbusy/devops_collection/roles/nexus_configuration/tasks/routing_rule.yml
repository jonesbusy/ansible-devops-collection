---
- name: Retrieve rule
  ansible.builtin.uri:
    method: GET
    url: "{{ nexus_configuration_nexus_url }}/service/rest/v1/routing-rules/{{ rule.name }}"
    status_code: [200, 404]
    return_content: yes
    url_username: "{{ nexus_configuration_username }}"
    url_password: "{{ nexus_configuration_password }}"
    validate_certs: "{{ nexus_configuration_validate_certs }}"
    force_basic_auth: yes
  register: nexus_result
  when: not ansible_check_mode
  changed_when: false

- name: Create rule
  ansible.builtin.uri:
    method: POST
    url: "{{ nexus_configuration_nexus_url }}/service/rest/v1/routing-rules"
    status_code: [204]
    body_format: json
    body: "{{ lookup('template', 'routing_rule.json.j2') }}"
    return_content: yes
    url_username: "{{ nexus_configuration_username }}"
    url_password: "{{ nexus_configuration_password }}"
    validate_certs: "{{ nexus_configuration_validate_certs }}"
    force_basic_auth: yes
  when: not ansible_check_mode and nexus_result.status == 404
  changed_when: true

- name: Update rule
  ansible.builtin.uri:
    method: PUT
    url: "{{ nexus_configuration_nexus_url }}/service/rest/v1/routing-rules/{{ rule.name }}"
    status_code: [204]
    body_format: json
    body: "{{ lookup('template', 'routing_rule.json.j2') }}"
    return_content: yes
    url_username: "{{ nexus_configuration_username }}"
    url_password: "{{ nexus_configuration_password }}"
    validate_certs: "{{ nexus_configuration_validate_certs }}"
    force_basic_auth: yes
  when: not ansible_check_mode and nexus_result.status == 200
  changed_when: false